language: minimal
os: linux

# Integration tests need to run first to reset the PR build status to pending
stages:
  - name: 'Integration tests'
    if: branch = hello
  - name: lint
  - name: 'Unit tests'
    if: branch = hello
  - name: 'Release Prep'
#    if: branch =~ /^prep/ and type = pull_request
#  - name: deploy
#    if: type = push AND tag =~ /^v\d+\.\d+\.\d+$/
#    if: type = push

jobs:
  include:
#    - stage: 'Integration tests'
      name: 'Trigger Integration Tests'
      language: minimal
      os: linux
      env:
        - SDK=objective-c
        - BUILD_NUMBER=$TRAVIS_BUILD_NUMBER
        - TESTAPP_TAG=master
      cache: false
      before_install: skip
      install: skip
      before_script:
        - mkdir $HOME/travisci-tools && pushd $HOME/travisci-tools && git init && git pull https://$CI_USER_TOKEN@github.com/optimizely/travisci-tools.git && popd
      script:
        - "$HOME/travisci-tools/fsc-trigger/trigger_fullstack-sdk-compat.sh"

    - stage: lint
      name: 'SourceClear and Lint'
      language: objective-c
      os: osx
      addons:
        srcclr: true
      install: gem install cocoapods
      script:
        - pod spec lint --quick

    - &unittests
      stage: 'Unit tests'
      language: objective-c
      os: osx
      osx_image: xcode10
      branches:
        only:
          - master
      env: SCHEME=OptimizelySDKiOS TEST_SDK=iphonesimulator PLATFORM='iOS Simulator' OS=9.1 NAME='iPad Air'
      name: PLATFORM='iOS Simulator' OS=9.1 NAME='iPad Air'
      before_install:
        - gem install slather --no-rdoc --no-ri --no-document --quiet
      script:
        - if [[ "$TRAVIS_BRANCH" == "master" ]]; then xcodebuild test -quiet -workspace OptimizelySDK.xcworkspace -scheme $SCHEME -configuration Release CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO -sdk $TEST_SDK -destination "platform=$PLATFORM,OS=$OS,name=$NAME" ONLY_ACTIVE_ARCH=YES | egrep -B 10 -A 10 "(error|failed|crash|exit|FAILED|Failing|failures)"; fi
      after_success:
        - slather
        - sleep 5 # https://github.com/travis-ci/travis-ci/issues/4725
    - <<: *unittests
      env: SCHEME=OptimizelySDKiOS TEST_SDK=iphonesimulator PLATFORM='iOS Simulator' OS=10.1 NAME='iPhone 7 Plus'
      name: PLATFORM='iOS Simulator' OS=10.1 NAME='iPhone 7 Plus'
    - <<: *unittests
      env: SCHEME=OptimizelySDKiOS TEST_SDK=iphonesimulator PLATFORM='iOS Simulator' OS=10.3.1 NAME='iPhone 7'
      name: PLATFORM='iOS Simulator' OS=10.3.1 NAME='iPhone 7'
    - <<: *unittests
      env: SCHEME=OptimizelySDKiOS-Universal TEST_SDK=iphonesimulator PLATFORM='iOS Simulator' OS=11.1 NAME='iPhone 6s'
      name: PLATFORM='iOS Simulator' OS=11.1 NAME='iPhone 6s'
    - <<: *unittests
      env: SCHEME=OptimizelySDKTVOS TEST_SDK=appletvsimulator PLATFORM='tvOS Simulator' OS=10.2 NAME='Apple TV 1080p'
      name: PLATFORM='tvOS Simulator' OS=10.2 NAME='Apple TV 1080p'
    - <<: *unittests
      env: SCHEME=OptimizelySDKTVOS-Universal TEST_SDK=appletvsimulator PLATFORM='tvOS Simulator' OS=9.2 NAME='Apple TV 1080p'
      name: PLATFORM='tvOS Simulator' OS=9.2 NAME='Apple TV 1080p'

    - stage: 'Release Prep'
      language: objective-c
      os: osx
      name: Prep for new release
      env:
        global:
          - VERSION=3.0.3
          - COLOR_RESET='\033[0m'
          - COLOR_MAGENTA='\033[0;35m'
          - COLOR_CYAN='\033[0;36m'
      install:
        - brew install hub
      script:
        # clone down repo
        - mkdir $HOME/objective-c-sdk
        - git clone https://$CI_USER_TOKEN@github.com/optimizely/objective-c-sdk.git $HOME/objective-c-sdk
        - git checkout -b optibot/auto_prepareRelease$VERSION
        - Scripts/build_all.sh
        # when is this needed / not needed?
        - Scripts/unexported_symbols.sh
        - Scripts/test_all.sh | tee testlog.txt
        - Scripts/update_version.sh $VERSION
        - git commit -m "ci(travis): automated release prep for $VERSION" --author "optibot <optibot@users.noreply.github.com>" -a
#        - git push https://$CI_USER_TOKEN@github.com/optimizely/objective-c-sdk.git optibot/auto_prepareRelease$VERSION
#        - PR_URL=$(hub pull-request --no-edit) && echo "${COLOR_CYAN}ATTENTION:${COLOR_RESET} review and merge ${PR_URL} to continue..."
